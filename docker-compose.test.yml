# version: '3.8'
services:
  # Mocked API Gateway for Testing
  api-gateway:
    build: ./api-gateway/
    ports:
      - "8001:8000" # Use different port to avoid conflict
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: "/kong.yml"
    volumes:
      - ./api-gateway/kong.yml:/kong.yml
      - ./api-gateway/kong.conf:/etc/kong/kong.conf

  # NOTE: User Service
  user-service:
    build: ./services/user-service
    ports:
      - "5001:5000"
    environment:
      - DATABASE_URL=postgres://test_user:test_password@user_db:5432/test_user_db
      - SECRET_KEY=${SECRET_KEY}

  # NOTE: Mocked User Database for testing
  user_db:
    image: postgres:latest
    environment:
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
      - POSTGRES_DB=test_user_db
    ports:
      - "5432:5432" # Same port as in dev, you can change this for testing
    volumes:
      - user_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d test_user_db"]
      interval: 10s
      retries: 5
      start_period: 30s

volumes:
  user_test_data:
